<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="chatbot.css" />
</head>
<body>
    <div class = "js-container"></div>

    <script src = "https://unpkg.com/supersimpledev/react.js"></script>
    <script src = "https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src = "https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src = "https://unpkg.com/supersimpledev/babel.js"></script>
    <script type = "text/babel">

        function ChatInput({chatMessages, setChatMessages,loading,setLoading}){
            const [ inputText, setInputText] = React.useState('');

            function saveInputText(event){
                setInputText(event.target.value);
            }

            function enterInputText(event){
                if(event.key === 'Enter'){
                    sendMessage();
                }
                else if(event.key === 'Escape'){
                    setInputText('');
            }
            }

            async function sendMessage(){
                if(loading || inputText === '') return;

                const newChatMessages  = [
                    ...chatMessages,{
                        message : inputText , sender : 'human' , id : crypto.randomUUID()
                    }
                ]

                setLoading(true);
                setChatMessages(newChatMessages);

                const response = await Chatbot.getResponseAsync(inputText);

                setChatMessages([
                    ...newChatMessages,{
                        message : response , sender : 'robot' , id : crypto.randomUUID()
                    }
                ]);
                 
                setInputText('');
                setLoading(false);
            }
            return (
                <div className = "input-container">
                  <input 
                    placeholder = "Send a message to the Chatbot"
                    size = "30"
                    onChange = {saveInputText}
                    value = {inputText}
                    onKeyDown = {enterInputText}
                    className = "textarea"
                  />
                  <button 
                    onClick = {sendMessage}
                    className = "send-button">send</button>
                </div>
            );
        }

        function ChatMessage({ message ,sender }){
            return (
                <div className = {sender === 'human' ? 'chat-human' : 'chat-robot'}>
                    {sender === "robot" && <img src = "robot.png" className = "image" /> }
                    <div className = "chat-message">{message}</div>
                    {sender === "human" && <img src = "user.png" className = "image" /> }
                </div>
            );
        }

        function ChatMessages({chatMessages,loading}){
            const chatMessagesRef = React.useRef(null);
            React.useEffect(()=>{
                const containerElem = chatMessagesRef.current;
                if(containerElem){
                    containerElem.scrollTop = containerElem.scrollHeight;
                }
            },[chatMessages]);
            return (
                <div className = "chat-messages-container" ref = {chatMessagesRef} >
            {chatMessages.map((Chatmessage) => {
                return (
                    <ChatMessage 
                        message = {Chatmessage.message}
                        sender = {Chatmessage.sender}
                        key = {Chatmessage.id}
                    />
                );
        })}

        {loading && (
                <ChatMessage
                    message="Loading..."
                    sender="bot"
                />
            )}

        </div>
    );
          } 

        function App(){
            const [loading,setLoading] = React.useState(false);
            const [ chatMessages , setChatMessages ] = React.useState([]);
            // const [ ChatMessages , setChatMessages ] = array; // similar to the next two lines
            // const ChatMessages = array[0];
            // const setChatMessages = array[1];
            
            return(
                <div className = "app-container">
                     <ChatMessages 
                        chatMessages = {chatMessages}
                        loading = {loading}
                     />
                     <ChatInput 
                        chatMessages = {chatMessages}
                        setChatMessages = {setChatMessages}
                        loading = {loading}
                        setLoading = {setLoading}
                     />
                    </div>
            );
        } 
        

        const container = document.querySelector('.js-container');
        ReactDOM.createRoot(container).render(<App />);
        

    </script>

</body>
</html>